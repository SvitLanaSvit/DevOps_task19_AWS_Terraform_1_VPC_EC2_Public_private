# üì¶ S3 Backend –¥–ª—è Terraform State

## –ß–æ–º—É –≤–∞–∂–ª–∏–≤–∏–π S3 Backend?

### –ü—Ä–æ–±–ª–µ–º–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ tfstate:
- üö´ –§–∞–π–ª –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –Ω–∞ –≤–∞—à–æ–º—É –∫–æ–º–ø'—é—Ç–µ—Ä—ñ
- üö´ –ù–µ–º–æ–∂–ª–∏–≤–∞ –∫–æ–º–∞–Ω–¥–Ω–∞ —Ä–æ–±–æ—Ç–∞
- üö´ –†–∏–∑–∏–∫ –≤—Ç—Ä–∞—Ç–∏ –ø—Ä–∏ –ø–æ–ª–æ–º—Ü—ñ –¥–∏—Å–∫–∞
- üö´ –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≤–µ—Ä—Å—ñ–æ–Ω—É–≤–∞–Ω–Ω—è —Ç–∞ –±–µ–∫–∞–ø—ñ–≤

### –ü–µ—Ä–µ–≤–∞–≥–∏ S3 Backend:
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è state
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–µ—Ä—Å—ñ–æ–Ω—É–≤–∞–Ω–Ω—è  
- ‚úÖ –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
- ‚úÖ –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è state (—á–µ—Ä–µ–∑ DynamoDB)
- ‚úÖ –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∫–æ–º–∞–Ω–¥–Ω–æ—ó —Ä–æ–±–æ—Ç–∏

### 1. S3 Bucket (`terraform-state-svitlana-vpc`)
- –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è tfstate —Ñ–∞–π–ª—É
- –í–µ—Ä—Å—ñ–æ–Ω—É–≤–∞–Ω–Ω—è —É–≤—ñ–º–∫–Ω–µ–Ω–æ
- –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è AES256
- –ó–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ –ø—É–±–ª—ñ—á–Ω–∏–π –¥–æ—Å—Ç—É–ø
- –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –≤–∏–¥–∞–ª–µ–Ω–Ω—è

### 2. DynamoDB —Ç–∞–±–ª–∏—Ü—è (`terraform-state-locks`)
- –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è state –ø—ñ–¥ —á–∞—Å –æ–ø–µ—Ä–∞—Ü—ñ–π
- –ó–∞–ø–æ–±—ñ–≥–∞—î –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∞–º –ø—Ä–∏ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ–π —Ä–æ–±–æ—Ç—ñ
- Billing mode: PAY_PER_REQUEST (–ø–ª–∞—Ç–∏—Ç–µ —Ç—ñ–ª—å–∫–∏ –∑–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è)

## üéØ **–ù–∞–≤—á–∞–ª—å–Ω–∞ —Ü—ñ–Ω–Ω—ñ—Å—Ç—å S3 Backend:**

### –î–ª—è —Ü—å–æ–≥–æ –ø—Ä–æ–µ–∫—Ç—É:
‚úÖ **–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ**: S3 backend –∑–∞–±–µ–∑–ø–µ—á—É—î:
- –ë–µ–∑–ø–µ—á–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è Terraform state
- –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è –ø–æ–º–∏–ª–æ–∫
- –ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ –¥–æ Infrastructure as Code

### –î–ª—è production:
üèÜ **–û–±–æ–≤'—è–∑–∫–æ–≤–æ**: S3 backend + DynamoDB locks:
- –ö–æ–º–∞–Ω–¥–Ω–∞ —Ä–æ–±–æ—Ç–∞ –±–µ–∑ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–µ—Ä—Å—ñ–æ–Ω—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω
- –†–µ–∑–µ—Ä–≤–Ω–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è state —Ñ–∞–π–ª—ñ–≤

## –ü–æ—Ä—è–¥–æ–∫ —Ä–æ–±–æ—Ç–∏:

### –ö—Ä–æ–∫ 1: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è S3 Bucket —á–µ—Ä–µ–∑ AWS Console

**üéØ –ú–µ—Ç–∞**: –°—Ç–≤–æ—Ä–∏—Ç–∏ S3 bucket –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è Terraform state —Ñ–∞–π–ª—ñ–≤

#### –í–∞—Ä—ñ–∞–Ω—Ç A: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —á–µ—Ä–µ–∑ AWS Console (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –¥–ª—è –Ω–∞–≤—á–∞–Ω–Ω—è)

1. **–í—ñ–¥–∫—Ä–∏–π—Ç–µ AWS S3 Console**: [https://s3.console.aws.amazon.com/](https://s3.console.aws.amazon.com/)

2. **–°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π bucket**:
   - –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **"Create bucket"**
   - **Bucket name**: `terraform-state-svitlana-vpc` (—É–Ω—ñ–∫–∞–ª—å–Ω–∞ –Ω–∞–∑–≤–∞)
   - **Region**: `eu-central-1` (Frankfurt)

   ![–°—Ç–≤–æ—Ä–µ–Ω–Ω—è S3 bucket - –∫—Ä–æ–∫ 1](../Screens/3.1_create_bucket.png)

3. **–ù–∞–ª–∞—à—Ç—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –±–µ–∑–ø–µ–∫–∏**:
   - **Block all public access**: ‚úÖ (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ!)
   - **Bucket Versioning**: Enable (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)
   - **Server-side encryption**: Enable (AES-256)

   ![–°—Ç–≤–æ—Ä–µ–Ω–Ω—è S3 bucket - –∫—Ä–æ–∫ 2](../Screens/3.2_create_bucket.png)

4. **–ó–∞–≤–µ—Ä—à—ñ—Ç—å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è**:
   - –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤—Å—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
   - –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **"Create bucket"**

   ![–°—Ç–≤–æ—Ä–µ–Ω–Ω—è S3 bucket - —Ä–µ–∑—É–ª—å—Ç–∞—Ç](../Screens/3.3_create_bucket.png)

#### –í–∞—Ä—ñ–∞–Ω—Ç B: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —á–µ—Ä–µ–∑ Terraform
```bash
# –°–ø–æ—á–∞—Ç–∫—É —Å—Ç–≤–æ—Ä—é—î–º–æ S3
# –¢–∏–º—á–∞—Å–æ–≤–æ –∑–∞–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ —Å–µ–∫—Ü—ñ—é backend –≤ main.tf

terraform init
terraform plan -var-file="environments/lab.tfvars"
terraform apply -var-file="environments/lab.tfvars"
```

### –ö—Ä–æ–∫ 2: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Terraform backend

#### üìù –û–Ω–æ–≤—ñ—Ç—å main.tf –∑ S3 backend –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—î—é:

```hcl
terraform {
  required_version = ">= 1.0"
  
  backend "s3" {
    bucket = "terraform-state-svitlana-vpc"
    key    = "terraform/terraform.tfstate"
    region = "eu-central-1"
    
    # –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ: –¥–ª—è –±–ª–æ–∫—É–≤–∞–Ω–Ω—è state
    # dynamodb_table = "terraform-state-locks"
    # encrypt        = true
  }
  
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}
```

### –ö—Ä–æ–∫ 3: –ú—ñ–≥—Ä–∞—Ü—ñ—è –Ω–∞ S3 backend
```bash
# –†–æ–∑–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ backend —Å–µ–∫—Ü—ñ—é –≤ main.tf
terraform init
# Terraform –∑–∞–ø—Ä–æ–ø–æ–Ω—É—î –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —ñ—Å–Ω—É—é—á–∏–π state –≤ S3
# –í—ñ–¥–ø–æ–≤—ñ–¥—å—Ç–µ "yes"
```

### –ö—Ä–æ–∫ 4: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ state —Ç–µ–ø–µ—Ä –≤ S3
aws s3 ls s3://terraform-state-svitlana-vpc/terraform/
```

## –ë–µ–∑–ø–µ–∫–∞:

‚ö†Ô∏è **–í–ê–ñ–õ–ò–í–û**:
- –ù—ñ–∫–æ–ª–∏ –Ω–µ –∫–æ–º–º—ñ—Ç—å—Ç–µ tfstate —Ñ–∞–π–ª–∏ –≤ git
- S3 bucket –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –ø—Ä–∏–≤–∞—Ç–Ω–∏–º
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ IAM –ø—Ä–∞–≤–∞ –¥–ª—è –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É
- –†–µ–≥—É–ª—è—Ä–Ω–æ —Ä–æ–±—ñ—Ç—å –±–µ–∫–∞–ø–∏

## Troubleshooting:

### –ü–æ–º–∏–ª–∫–∞ "bucket doesn't exist":
```bash
# –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è —â–æ bucket —Å—Ç–≤–æ—Ä–µ–Ω–∏–π
aws s3 ls | grep terraform-state

# –°—Ç–≤–æ—Ä—ñ—Ç—å bucket —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
aws s3 mb s3://terraform-state-svitlana-vpc --region eu-central-1
```

### –ü–æ–º–∏–ª–∫–∞ "DynamoDB table doesn't exist":
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ç–∞–±–ª–∏—Ü—é
aws dynamodb list-tables --region eu-central-1
```

## üßπ **Cleanup –ø—ñ—Å–ª—è –ø—Ä–æ–µ–∫—Ç—É:**

### –í–∏–¥–∞–ª–µ–Ω–Ω—è S3 Backend:
1. **–°–ø–æ—á–∞—Ç–∫—É**: `terraform destroy` (–≤–∏–¥–∞–ª—è—î –≤—Å—ñ —Ä–µ—Å—É—Ä—Å–∏)
2. **–ü–æ—Ç—ñ–º**: –í–∏–¥–∞–ª—ñ—Ç—å S3 bucket —á–µ—Ä–µ–∑ AWS Console
3. **–Ø–∫—â–æ —î DynamoDB**: –í–∏–¥–∞–ª—ñ—Ç—å —Ç–∞–±–ª–∏—Ü—é `terraform-state-locks`

‚ö†Ô∏è **–í–ê–ñ–õ–ò–í–û**: –ó–∞–≤–∂–¥–∏ —Å–ø–æ—á–∞—Ç–∫—É `terraform destroy`, –ø–æ—Ç—ñ–º –≤–∏–¥–∞–ª—è–π—Ç–µ backend!

---

## üì∏ **–°–∫—Ä—ñ–Ω—à–æ—Ç–∏ –ø—Ä–æ—Ü–µ—Å—É:**
- [3.1 - –ü–æ—á–∞—Ç–æ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è bucket](../Screens/3.1_create_bucket.png)
- [3.2 - –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤](../Screens/3.2_create_bucket.png)  
- [3.3 - –†–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è](../Screens/3.3_create_bucket.png)

---

**–ù–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫**: –ü—ñ—Å–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è backend —Å—Ç–≤–æ—Ä—é—î–º–æ VPC —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É.